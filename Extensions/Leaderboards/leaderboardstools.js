var gdjs;(function(S){const o=new S.Logger("Leaderboards");let G;(function(M){let _;(function(s){let T=!1;S.registerRuntimeScenePostEventsCallback(()=>{T=!1}),s.hasPlayerJustClosedLeaderboardView=()=>T;const U=t=>{const e=new jsSHA("SHA-256","TEXT",{encoding:"UTF8"});return e.update(t),e.getHash("B64")};class j{constructor(){this.lastScoreSavingStartedAt=null,this.lastScoreSavingSucceededAt=null,this.currentlySavingScore=null,this.currentlySavingPlayerName=null,this.currentlySavingPlayerId=null,this.lastSavedScore=null,this.lastSavedPlayerName=null,this.lastSavedPlayerId=null,this.lastSaveError=null,this.isScoreSaving=!1,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!1}isSameAsLastScore({playerName:e,playerId:n,score:r}){return(!!e&&this.lastSavedPlayerName===e||!!n&&this.lastSavedPlayerId===n)&&this.lastSavedScore===r}isAlreadySavingThisScore({playerName:e,playerId:n,score:r}){return(!!e&&this.currentlySavingPlayerName===e||!!n&&this.currentlySavingPlayerId===n)&&this.isScoreSaving&&this.currentlySavingScore===r}isTooSoonToSaveAnotherScore(){return!!this.lastScoreSavingStartedAt&&Date.now()-this.lastScoreSavingStartedAt<500}startSaving({playerName:e,playerId:n,score:r}){this.lastScoreSavingStartedAt=Date.now(),this.isScoreSaving=!0,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!1,this.currentlySavingScore=r,e&&(this.currentlySavingPlayerName=e),n&&(this.currentlySavingPlayerId=n)}closeSaving(){this.lastScoreSavingSucceededAt=Date.now(),this.lastSavedScore=this.currentlySavingScore,this.lastSavedPlayerName=this.currentlySavingPlayerName,this.lastSavedPlayerId=this.currentlySavingPlayerId,this.isScoreSaving=!1,this.hasScoreBeenSaved=!0}setError(e){this.lastSaveError=e,this.isScoreSaving=!1,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!0}}let l={},p,d=null,D=!1,y=!1,h=!1,m=null,w=null;const g=document.createElement("div");g.style.backgroundColor="#000000",g.style.display="flex",g.style.height="100%",g.style.width="100%",g.style.justifyContent="center",g.style.alignItems="center",g.style.position="relative",g.style.zIndex="2";const b=document.createElement("img");b.setAttribute("width","50px"),b.setAttribute("src","data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCI+CjxjaXJjbGUgb3BhY2l0eT0nMC4yNScgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iNCI+PC9jaXJjbGU+CjxwYXRoIG9wYWNpdHk9JzAuNzUnIGZpbGw9IiNGRkZGRkYiIGQ9Ik00IDEyYTggOCAwIDAxOC04VjBDNS4zNzMgMCAwIDUuMzczIDAgMTJoNHptMiA1LjI5MUE3Ljk2MiA3Ljk2MiAwIDAxNCAxMkgwYzAgMy4wNDIgMS4xMzUgNS44MjQgMyA3LjkzOGwzLTIuNjQ3eiI+PC9wYXRoPgo8L3N2Zz4=");try{b.animate([{transform:"rotate(0deg)"},{transform:"rotate(359deg)"}],{duration:3e3,iterations:1/0})}catch{o.warn("Animation not supported, loader will be fixed.")}g.appendChild(b);const E=function({hasSucceeded:t}){const e=a=>t?a.lastScoreSavingSucceededAt:a.lastScoreSavingStartedAt,n=Object.values(l).filter(a=>!!e(a));if(n.length===0)return null;let r=n[0];return n.forEach(a=>{const i=e(a),c=e(r);i&&c&&i>c&&(r=a)}),r},P=function({leaderboardId:t,playerName:e,authenticatedPlayerData:n,score:r,scoreSavingState:a,runtimeScene:i}){const I=`${i.getGame().isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/play`,C=i.getGame(),N={score:r,sessionId:C.getSessionId(),clientPlayerId:C.getPlayerId(),location:typeof window!="undefined"&&window.location?window.location.href:""},L={"Content-Type":"application/json"};let O=`${I}/game/${S.projectData.properties.projectUuid}/leaderboard/${t}/entry`;n?(L.Authorization=`player-game-token ${n.playerToken}`,O+=`?playerId=${n.playerId}`):N.playerName=s.formatPlayerName(e);const k=JSON.stringify(N);L.Digest=U(k),fetch(O,{body:k,method:"POST",headers:L}).then(v=>{if(!v.ok){const u=v.status.toString();o.error("Server responded with an error:",u,v.statusText),a.setError(u);return}return a.closeSaving(),v.text().then(u=>{},u=>{o.warn("An error occurred when reading response but score has been saved:",u)})},v=>{o.error("Error while submitting a leaderboard score:",v);const u="REQUEST_NOT_SENT";a.setError(u)})};s.savePlayerScore=function(t,e,n,r){let a;if(l[e]){a=l[e];let i=!0;if(i&&a.isAlreadySavingThisScore({playerName:r,score:n})&&(o.warn("There is already a request to save with this player name and this score. Ignoring this one."),i=!1),i&&a.isSameAsLastScore({playerName:r,score:n})&&(o.warn("The player and score to be sent are the same as previous one. Ignoring this one."),a.setError("SAME_AS_PREVIOUS"),i=!1),i&&a.isTooSoonToSaveAnotherScore()&&(o.warn("Last entry was sent too little time ago. Ignoring this one."),a.setError("TOO_FAST"),i=!1,a.lastScoreSavingStartedAt=Date.now()),!i)return}else a=new j,l[e]=a;a.startSaving({playerName:r,score:n}),P({leaderboardId:e,playerName:r,score:n,scoreSavingState:a,runtimeScene:t})},s.saveConnectedPlayerScore=function(t,e,n){let r;const a=S.playerAuthentication.getUserId(),i=S.playerAuthentication.getUserToken();if(!a||!i){o.warn("Cannot save a score for a connected player if the player is not connected.");return}if(l[e]){r=l[e];let c=!0;if(c&&r.isAlreadySavingThisScore({playerId:a,score:n})&&(o.warn("There is already a request to save with this player ID and this score. Ignoring this one."),c=!1),c&&r.isSameAsLastScore({playerId:a,score:n})&&(o.warn("The player and score to be sent are the same as previous one. Ignoring this one."),r.setError("SAME_AS_PREVIOUS"),c=!1),c&&r.isTooSoonToSaveAnotherScore()&&(o.warn("Last entry was sent too little time ago. Ignoring this one."),r.setError("TOO_FAST"),c=!1,r.lastScoreSavingStartedAt=Date.now()),!c)return}else r=new j,l[e]=r;r.startSaving({playerId:a,score:n}),P({leaderboardId:e,authenticatedPlayerData:{playerId:a,playerToken:i},score:n,scoreSavingState:r,runtimeScene:t})},s.isSaving=function(t){if(t)return l[t]?l[t].isScoreSaving:!1;const e=E({hasSucceeded:!1});return e?e.isScoreSaving:!1},s.hasBeenSaved=function(t){if(t)return l[t]?l[t].hasScoreBeenSaved:!1;const e=E({hasSucceeded:!0});return e?e.hasScoreBeenSaved:!1},s.hasSavingErrored=function(t){if(t)return l[t]?l[t].hasScoreSavingErrored:!1;const e=E({hasSucceeded:!1});return e?e.hasScoreSavingErrored:!1},s.getLastSaveError=function(t){if(t)return l[t]?l[t].lastSaveError:"NO_DATA_ERROR";const e=E({hasSucceeded:!1});return e?e.lastSaveError:"NO_DATA_ERROR"},s.formatPlayerName=function(t){return!t||typeof t!="string"||typeof t=="string"&&t.length===0?`Player${Math.round((Math.random()*9+1)*1e4)}`:t.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s/g,"_").replace(/[^\w|-]/g,"").slice(0,30)};const z=function(t){return fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.ok?!0:(o.error(`Error while fetching leaderboard view, server returned: ${e.status} ${e.statusText}`),!1),e=>(o.error("Error while fetching leaderboard view:",e),!1))},B=function(t,e,n){switch(n.data){case"closeLeaderboardView":T=!0,s.closeLeaderboardView(t);break;case"leaderboardViewLoaded":if(e&&(m&&clearTimeout(m),A(!1,t,{callOnErrorIfDomElementContainerMissing:!1})),!d){f(t,"The leaderboard view couldn't be found. Doing nothing.");return}d.style.opacity="1",h=!0,y=!1;break}},f=function(t,e){o.error(e),D=!0,y=!1,s.closeLeaderboardView(t)},x=t=>{m&&clearTimeout(m),m=setTimeout(()=>{h||f(t,"Leaderboard page did not send message in time. Closing leaderboard view.")},5e3)},A=function(t,e,n){const r=e.getGame().getRenderer().getDomElementContainer();if(!r)return n.callOnErrorIfDomElementContainerMissing&&f(e,"The div element covering the game couldn't be found, the leaderboard cannot be displayed."),!1;if(t)r.children&&r.children.length>0?r.insertBefore(g,r.children[0]):r.appendChild(g),d&&(d.style.opacity="0");else try{r.removeChild(g),d&&(d.style.opacity="1")}catch{}return!0},$=function(t){const e=document.createElement("iframe");return e.src=t,e.id="leaderboard-view",e.style.position="absolute",e.style.opacity="0",e.style.pointerEvents="all",e.style.backgroundColor="#FFFFFF",e.style.top="0px",e.style.height="100%",e.style.left="0px",e.style.width="100%",e.style.border="none",e};s.displayLeaderboard=function(t,e,n){if(e===p){if(y){o.warn(`Already loading the view for the requested loader (${e}), ignoring.`);return}if(h){o.warn(`Already loaded the view for the requested loader (${e}), ignoring.`);return}}p=e,D=!1,h=!1,y=!0,n&&A(!0,t,{callOnErrorIfDomElementContainerMissing:!0});const r=S.projectData.properties.projectUuid,a=t.getGame().isUsingGDevelopDevelopmentEnvironment(),i=`https://gd.games/games/${r}/leaderboard/${e}?inGameEmbedded=true${a?"&dev=true":""}`;z(i).then(c=>{if(e!==p){o.warn(`Received a response for leaderboard ${e} though the last leaderboard requested is ${p}, ignoring this response.`);return}if(!c){f(t,"Leaderboard data could not be fetched. Closing leaderboard view if there is one.");return}if(d)x(t),n&&A(!0,t,{callOnErrorIfDomElementContainerMissing:!1}),d.src=i;else{const I=t.getGame().getRenderer().getDomElementContainer();if(!I){f(t,"The div element covering the game couldn't be found, the leaderboard cannot be displayed.");return}x(t),d=$(i),typeof window!="undefined"&&(w=C=>{B(t,n,C)},window.addEventListener("message",w,!0)),I.appendChild(d)}},c=>{o.error(c),f(t,"An error occurred when fetching leaderboard data. Closing leaderboard view if there is one.")})},s.isLeaderboardViewErrored=function(){return D},s.isLeaderboardViewLoaded=function(){return h},s.isLeaderboardViewLoading=function(){return y},s.closeLeaderboardView=function(t){try{if(A(!1,t,{callOnErrorIfDomElementContainerMissing:!1}),!d){o.info("The iframe displaying the current leaderboard couldn't be found, the leaderboard view must be already closed.");return}const e=t.getGame().getRenderer().getDomElementContainer();if(!e){o.info("The div element covering the game couldn't be found, the leaderboard view must be already closed.");return}typeof window!="undefined"&&(window.removeEventListener("message",w,!0),w=null),e.removeChild(d),d=null}finally{h=!1;const e=t.getGame().getRenderer().getCanvas();e&&e.focus()}}})(_=M.leaderboards||(M.leaderboards={}))})(G=S.evtTools||(S.evtTools={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=leaderboardstools.js.map
